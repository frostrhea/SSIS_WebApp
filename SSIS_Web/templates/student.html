{% extends "base.html" %} {% block title %} Student List {% endblock %}  {% block content %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/templates.css') }}"
/>

<div class="container mt-2">
  <!-- Search bar and Add button row -->
  <div class="row mb-3">
    <div class="col">
      <h1 class="header" >Student List.</h1> 
    </div>
    <div class="col mt-auto">
      <!-- Button to trigger the modal -->
      <button type="button" class="btn btn-outline-info" id="addButton">
        <img src="/static/assets/add.png" alt="Add" class="icon" />
        Add Student
      </button>
    </div>
    <div class="col order-md-last mt-auto">
      <!-- Dropdown menu for selecting search field and input field for search query -->
      <div class="field-selection">
        <!-- Dropdown menu for selecting search field -->
        <select class="form-control search-selector" id="searchField">
          <option value="all">All columns</option>
          <option value="id">ID</option>
          <option value="firstname">First name</option>
          <option value="lastname">Last name</option>
          <option value="course">Course</option>
          <option value="year">Year</option>
          <option value="gender">Gender</option>
        </select>

        <!-- Input field for search query -->
        <form id="searchForm" class="col-md-9">
        <div class="input-group custom-search-input ">
          <input
            type="text"
            class="form-control custom-search-input"
            id="searchInput"
            placeholder="Search"
          />
          <div class="input-group-append">
            <button
              type="button"
              class="btn btn-outline-info"
              id="searchButton"
            >
              <img src="/static/assets/search.png" alt="Search" class="icon" />
            </button>
          </div>
        </form>
        </div>
      </div>
    </div>
  </div>

  <div class="table-container">
    <!-- Bootstrap-styled table -->
    <table class="table table-hover">
      <!-- Table header -->
      <thead>
        <tr>
          <th scope="col">ID</th>
          <th scope="col">First Name</th>
          <th scope="col">Last Name</th>
          <th scope="col">Course</th>
          <th scope="col">Year</th>
          <th scope="col">Gender</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Table rows for student data -->
        {% for student in student_data %}
        <tr>
          <!-- Data for each column -->
          <th scope="row" class="id">{{ student.id }}</th>
          <td class="firstname">{{ student.firstname }}</td>
          <td class="lastname">{{ student.lastname }}</td>
          <td class="course">{{ student.course }}</td>
          <td class="year">{{ student.year }}</td>
          <td class="gender">{{ student.gender }}</td>
          <td>
            <div class="btn-group" role="group">
              <!-- Edit button -->
              <button
                class="btn btn-outline-info btn-sm edit-button"
                data-toggle="modal"
                data-target="#editStudentModal"
                data-student-id="{{ student.id }}"
                data-firstname="{{ student.firstname }}"
                data-lastname="{{ student.lastname }}"
                data-course="{{ student.course }}"
                data-year="{{ student.year }}"
                data-gender="{{ student.gender }}"
              >
                <img src="/static/assets/edit.png" alt="Edit" class="icon" />
                Edit
              </button>
              
              <!-- Delete button form -->
              <form
                id="deleteStudentForm"
                action="/students/delete/{{ student.id }}"
                method="POST"
              >
                {{ form.hidden_tag() }}
                <button
                  class="btn btn-outline-danger btn-sm delete-button ml-10"
                  data-student-id="{{ student.id }}"
                  id="deleteStudentFromList"
                >
                  <img
                    src="/static/assets/delete.png"
                    alt="Delete"
                    class="icon"
                  />
                  Delete
                </button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- EDIT Student Modal -->
<div class="modal fade" id="editStudentModal" tabindex="-1" role="dialog" aria-labelledby="editStudentModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
      <h5 class="modal-title" id="editStudentModalLabel">Edit Student</h5>
      </div>
      <div class="modal-body">
        <!-- Form to edit an existing student -->
        <form
          action="/students/edit/"
          method="POST"
          class="editStudentForm"
          id="editStudentForm"
        >
          <!-- Input fields for student information -->
          <div class="form-group">
            <label for="studentID">ID Number</label>
            <input
              type="text"
              class="form-control"
              id="studentID"
              name="studentID"
              value="{{ existing_id  }}"
              
              required
            />
          </div>
          <div class="form-group">
            <label for="firstName">First Name</label>
            <input
              type="text"
              class="form-control"
              id="firstName"
              name="firstName"
              data-student-id=""
              required
            />
          </div>
          <div class="form-group">
            <label for="lastName">Last Name</label>
            <input
              type="text"
              class="form-control"
              id="lastName"
              name="lastName"
              data-student-id=""
              required
            />
          </div>
          <div class="form-group">
            <label for="course">Course</label>
            <select
              type="text"
              class="form-control"
              id="course"
              name="course"
              data-student-id=""
              required
            >
            {% for course in courses %}
              <option value="{{ course.code }}">{{ course.name }}</option>
            {% endfor %}
            </select>
          </div>
                
          <div class="form-group">
            <label for="year">Year</label>
            <input
              type="number"
              class="form-control"
              id="year"
              name="year"
              data-student-id=""
              required
            />
          </div>
          <div class="form-group">
            <label for="gender">Gender</label>
            <select class="form-control" id="gender" name="gender" required>
              <option value="" disabled selected class="disabled-option" >Select gender</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Non-binary">Non-binary</option>
              <option value="Transgender">Transgender</option>
              <option value="Prefer not to say">Prefer not to say</option>
              <option value="Not listed">Not listed</option>
            </select>
          </div>
         
          <!-- Hidden input field to store the current course -->
          <input type="hidden" id="currentCourse" name="currentCourse" />

          <!-- CSRF Token -->
          {{ form.hidden_tag() }}

          <!-- Modal footer with submit button -->
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              id="closeEditModalButton"
              data-dismiss="modal"
            >
              Close
            </button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
          
        </form>
      </div>
    </div>
  </div>
</div>
  

        
    
  <!-- Add Student Modal -->
  <div
    class="modal fade"
    id="addStudentModal"
    tabindex="-1"
    role="dialog"
    aria-labelledby="addStudentModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addStudentModalLabel">
            Add New Student
          </h5>
        </div>
        <div class="modal-body">
          <!-- Form to add a new student -->
          <form id="addStudentForm" action="/students/add" method="POST">
            <!-- Input fields for student information -->
            <div class="form-group">
              <label for="studentID">ID Number</label>
              <input
                type="text"
                class="form-control"
                id="studentID"
                name="studentID"
                required
              />
            </div>
            <div class="form-group">
              <label for="firstName">First Name</label>
              <input
                type="text"
                class="form-control"
                id="firstName"
                name="firstName"
                required
              />
            </div>
            <div class="form-group">
              <label for="lastName">Last Name</label>
              <input
                type="text"
                class="form-control"
                id="lastName"
                name="lastName"
                required
              />
            </div>
            <div class="form-group">
              <label for="course">Course</label>
              <select class="form-control" id="course" name="course" required>
                <option value="" disabled selected class="disabled-option">Select a course</option>
                  {% for course in courses %}
                    <option value="{{ course.code }}">{{ course.name }}</option>
                  {% endfor %}
              </select>
            </div>
          
            <div class="form-group">
              <label for="year">Year</label>
              <input
                type="number"
                class="form-control"
                id="year"
                name="year"
                required
              />
            </div>
            <div class="form-group">
              <label for="gender">Gender</label>
              <select
                class="form-control"
                id="gender"
                name="gender"
                required
              >
              <option value="" disabled selected class="disabled-option">Select gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Non-binary">Non-binary</option>
                <option value="Transgender">Transgender</option>
                <option value="Prefer not to say">Prefer not to say</option>
                <option value="Not listed">Not listed</option>
              </select>
            </div>

            <!-- Hidden input fields to store form data -->
            <input
              type="hidden"
              id="hiddenIDNumber"
              name="hiddenFIDNumber"
            />
            <input
              type="hidden"
              id="hiddenFirstName"
              name="hiddenFirstName"
            />
            <input
              type="hidden"
              id="hiddenLastName"
              name="hiddenLastName"
            />
            <input type="hidden" id="hiddenCourse" name="hiddenCourse" />
            <input type="hidden" id="hiddenYear" name="hiddenYear" />
            <input type="hidden" id="hiddenGender" name="hiddenGender" />

            <!-- CSRF Token -->
            {{ form.hidden_tag() }}

            <!-- Modal footer with submit button -->
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                id="closeAddModalButton"
                data-dismiss="modal"
              >
                Close
              </button>
              <button type="submit" class="btn btn-primary">
                Add Student
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
$(document).ready(function () {
   $("#addButton").click(function () {
      // Clear input fields and hidden fields when the modal is opened
      $("#addStudentForm")[0].reset();
      $("#hiddenIDNumber").val("");
      $("#hiddenFirstName").val("");
      $("#hiddenLastName").val("");
      $("#hiddenCourse").val("");
      $("#hiddenYear").val("");
      $("#hiddenGender").val("");
      
      $("#addStudentModal").modal("show");
    });

    $("#addStudentForm").submit(function (event) {
      // Update hidden input fields with form data
      console.log("Form Data before submission:", $("#addStudentForm").serialize());
      $("#hiddenIDNumber").val($("#idnumber").val());
      $("#hiddenFirstName").val($("#firstName").val());
      $("#hiddenLastName").val($("#lastName").val());
      $("#hiddenCourse").val($("#course").val());
      $("#hiddenYear").val($("#year").val());
      $("#hiddenGender").val($("#gender").val());
      console.log("Form submitted!"); 
    });

  // Close add modal function
  function closeAddModal() {
    $("#addStudentModal").modal("hide");
  }

  $("#closeAddModalButton").click(function () {
    closeAddModal();
  });


  $("#deleteStudentFromList").click(function (event) {
    if (!confirm("Are you sure you want to delete this student?")) {
      event.preventDefault();
    } else {
      var studentId = $(this).data("student-id");
    }
  });

  $("#searchButton").click(function(event) {
    event.preventDefault(); // Prevent default button click behavior
    performSearch();
});

  $("#searchForm").submit(function(event) {
        event.preventDefault(); // Prevent default form submission
        performSearch();
    });

    function performSearch() {
        var searchField = $("#searchField").val();
        var searchQuery = $("#searchInput").val().toLowerCase();

        $(".table-hover tbody tr").each(function () {
            var rowData = $(this)
                .find("." + searchField)
                .text()
                .toLowerCase();

            if (searchField === "all") {
                rowData = $(this).text().toLowerCase();
            }

            // Show/hide rows based on search query
            if (rowData.includes(searchQuery)) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    }



   // Edit Modal
   function closeEditModal() {
    $("#editStudentModal").modal("hide");
  }

  $("#closeEditModalButton").click(function () {
    closeEditModal();
  });
  

  $(".edit-button").click(function () {
    var studentId = $(this).data("student-id");
    var firstname = $(this).data("firstname");
    var lastname = $(this).data("lastname");
    var course = $(this).data("course");
    var year = $(this).data("year");
    var gender = $(this).data("gender");
    var currentCourse = $(this).data("course");

    // Populate the form fields with the student data
    $("#editStudentForm input[name='studentID']")
      .val(studentId)
      .data("student-id", studentId);
    $("#editStudentForm input[name='firstName']")
      .val(firstname)
      .data("student-id", studentId);
    $("#editStudentForm input[name='lastName']")
      .val(lastname)
      .data("student-id", studentId);
    $("#editStudentForm input[name='course']")
      .val(course)
      .data("student-id", studentId);
    $("#editStudentForm input[name='year']")
      .val(year)
      .data("student-id", studentId);
    $("#editStudentForm select[name='gender']")
      .val(gender)
      .data("student-id", studentId);
    $("#currentCourse").val(currentCourse);
  

    // Pre-select the correct option in the select field
    $("#course").val(currentCourse);

    // Show the form for editing
    $("#editStudentModal").modal("show");
  });

$("#editStudentForm").submit(function(event) {
    event.preventDefault();

    var studentId = $("#editStudentForm input[name='studentID']").data("student-id");
    console.log("Old ID before appending:", studentId);
    console.log("Form Data before submission:", $("#editStudentForm").serialize());
    $("#editStudentForm").append('<input type="hidden" name="old_id" value="' + studentId + '">');
    $("#editStudentForm").unbind('submit').submit();
});

});

//-----

$("#resetButton").click(function () {
  $(".table-striped tbody tr").show();
});
</script>

{% endblock %}
  
// ISSUE: default course in edit student form shows incorrect course (first course)